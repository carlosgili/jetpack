<?php
/**
 * Tool used to generate the jetpack/modules/module-registration.php file.
 * Useing the Module header comment information that is currently available in each module.
 *
 * @package Jetpack
 */
$file_contents = "<?php
/**
 * DO NOT EDIT THIS FILE. 
 * It's generated by running `php tools/build-module-registration.php` in the command line from the jetpack directory.
 *
 * Registers all the modules so that Jetpack knows about them.
 *
 * @package Jetpack
 */

";

$jetpack_directory = dirname( dirname( __FILE__ ) ) . '/';
$files  = glob( "{$jetpack_directory}modules/*.php" );
$output_file = "{$jetpack_directory}modules/module-registration.php";

foreach ( $files as $file ) {
	$absolute_path = $file;
	$relative_path = str_replace( $jp_dir, '', $file );
	$_module_arguments = null;

	$file = fopen( $absolute_path, 'r' );
	$file_data = fread( $file, 8192 );
	fclose( $file );

	// Make sure we catch CR-only line endings.
	$file_data   = str_replace( "\r", "\n", $file_data );
	$all_headers = array(
		'name'                      => 'Module Name',
		'description'               => 'Module Description',
		'jumpstart_desc'            => 'Jumpstart Description',
		'sort'                      => 'Sort Order',
		'recommendation_order'      => 'Recommendation Order',
		'introduced'                => 'First Introduced',
		'changed'                   => 'Major Changes In',
		'deactivate'                => 'Deactivate',
		'free'                      => 'Free',
		'requires_connection'       => 'Requires Connection',
		'auto_activate'             => 'Auto Activate',
		'module_tags'               => 'Module Tags',
		'feature'                   => 'Feature',
		'additional_search_queries' => 'Additional Search Queries',
		'plan_classes'              => 'Plans',
	);

	foreach ( $all_headers as $field => $regex ) {
		if ( preg_match( '/^[ \t\/*#@]*' . preg_quote( $regex, '/' ) . ':(.*)$/mi', $file_data, $match ) && $match[1] ) {
			$string = trim( preg_replace( "/\s*(?:\*\/|\?>).*/", '', $match[1] ) );
			$string = addcslashes( $string, "''" );

			// Translate string on registration.
			switch( $field ) {
				// Convert to translated string.
				case 'name':
				case 'description':
				case 'jumpstart_desc':
					$_module_arguments .= "\t\t'{$field}' => _x( '{$string}', '{$regex}', 'jetpack' ),\n";
					break;
				// Convert to translated string array.
				case 'module_tags':
				case 'feature':
					$module_tags = array_map( 'trim', explode( ',', $string ) );
					$_tags = null;
					foreach ( $module_tags as $tag ) {
						$_tags .= "\t\t\t_x( '{$tag}', '{$regex}', 'jetpack' ),\n";
					}
					$_module_arguments .= "\t\t'{$field}' => array(\n{$_tags}\t\t),\n";
					break;
				// Convert to string array.
				case 'plan_classes':
					$_tags = null;
					$module_tags = array_map( 'trim', explode( ',', $string ) );
					foreach ( $module_tags as $tag ) {
						$_tags .= "\t\t\t '{$tag}',\n";
					}
					$_module_arguments .= "\t\t'{$field}' => array(\n{$_tags}\t\t),\n";
					break;
				// Convert to integers.
				case 'sort':
				case 'recommendation_order':
					$string = intval( $string );
					$_module_arguments .= "\t\t'{$field}' => {$string},\n";
					break;
				// Convert to boolean from true and false
				case 'free':
				case 'deactivate':
					$boolean = $string === 'false' ? 'false': 'true';
					$_module_arguments .= "\t\t'{$field}' => {$boolean},\n";
					break;
				// Convert to boolean from Yes and No.
				case 'requires_connection':
					$boolean = $string === 'Yes' ? 'true': 'false';
					$_module_arguments .= "\t\t'{$field}' => {$boolean},\n";
					break;
				// Convert to string.
				case 'additional_search_queries':
				case 'auto_activate':
				case 'introduced':
				case 'changed':
					$_module_arguments .= "\t\t'{$field}' => '{$string}',\n";
					break;
				default:
					$_module_arguments .= "\t\t'{$field}' => 'default... {$string}',\n";
					break;
			}
		}
	}

	// Only add module registration if a module was found in the file.
	if ( $_module_arguments ) {
		$module_slug = str_replace( '.php', '', basename( $absolute_path ) );
		$file_contents .= "jetpack_register_module( \n\t'{$module_slug}', \n\tarray(\n{$_module_arguments}\t) \n);";
		$file_contents .= "\n\n";
	}

	$_module_arguments = null;

}

$file_contents .= "\n";


file_put_contents( $output_file, $file_contents );
